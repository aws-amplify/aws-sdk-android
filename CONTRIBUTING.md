# Contributing Guidelines

Thank you for your interest in contributing to the Android distribution
of the AWS SDK. Whether it's a bug report, new feature,
correction, or additional documentation, the project maintainers at AWS
greatly value your feedback and contributions.

Please read through this document before submitting any issues or pull
requests. Doing so will help to ensure that the project maintainers have
all information necessary to effectively respond to your bug report or
contribution.

* [Getting Started](#getting-started)
* [Tools](#tools)
* [SDK Fundamentals](#sdk-fundamentals)
* [Workflows](#workflows)
* [Contributing via Pull Requests](#contributing-via-pull-requests)
* [Troubleshooting](#troubleshooting)
* [Related repositories](#related-repositories)
* [Finding contributions to work on](#finding-contributions-to-work-on)
* [Code of conduct](#code-of-conduct)
* [Security issue notifications](#security-issue-notifications)
* [Licensing](#licensing)

## Getting Started

First, ensure that you have installed the latest stable version of Android
Studio / the Android SDK.

Configure your environment, so that the `ANDROID_HOME` and `JAVA_HOME`
environment variables are set. A convenient way of doing this is to add them
into `~/.bashrc`. On a Mac, the SDK and Java installation used by the SDK may
be found:

```
export ANDROID_HOME=~/Library/Android/sdk
export JAVA_HOME=/Applications/Android\ Studio.app/Contents/jre/jdk/Contents/Home
```
Note: JDK 11, 12, 13, etc. have known issues and are not supported.

Now, clone the AWS SDK for Android project from GitHub.

```
git clone git@github.com:aws-amplify/aws-sdk-android.git
```
Load this project into Android Studio by selecting File > Open, and choosing
the root directory of the project (`aws-sdk-android`). Alternately, cd into this
top-level directory.

In Android Studio, build the project by clicking the Hammer icon, "Make Project
⌘F9". If working on the command line, you can do the same thing via:

```
./gradlew build
```

## Tools
[Gradle](https://gradle.org) is used for all [build and dependency management](https://developer.android.com/studio/build).

_Instrumentation tests_, which run on an Android device or emulator use
AndroidX test core, runner, and a jUnit extension. See Android's notes on
[using AndroidX for test](https://developer.android.com/training/testing/set-up-project).

## SDK Fundamentals
Here are a few fundamentals to keep in mind while developing in the AWS SDK for Android.

* Never embed credentials in an Android application.  It is trivially easy to decompile applications and steal embedded credentials.  Always use temporarily vended credentials from services such as Amazon Cognito Identity.
* Unless explicitly stated, calls are synchronous and must be taken off of the main thread.
* Unless explicitly stated, calls can always throw an AmazonServiceException or an AmazonClientException (depending on if the exception is generated by the service or the client respectively).
* The SDK will automatically retry requests. Unless explicitly stated otherwise, a call with throw an exception when all retries have been exhuasted.
* Unless there is a very compelling reason to do so, you should not modify any classes residing under the `com.amazonaws.services` package because those are auto-generated from service models. If you think one of these classes has an issue, please open an issue so we can investigate.
* We are always looking to help, please feel free to open an [issue](https://github.com/aws-amplify/aws-sdk-android/issues).

## Workflows

### Modifying code for a new feature or bug fix

Start by reading the guides on [Getting Started](#getting-started) and [Making a Pull Request](#pull-request)

When developing new features for the SDK, you should attempt to create your feature in isolation, preferrably as a separate project. This way, you can test your functionality independent to the main SDK. Unit tests are required for all features being added to the code-base. Once you have the skeleton of your feature working, you can integrate it into the existing source files.

Writing good Android code and good tests is far outside the scope of this
document. But, here are some of the conventions and expectations for source files in the Android codebase.

* All files get a copyright header with the year of creation;
```java
/*
 * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at
 *
 *  http://aws.amazon.com/apache2.0
 *
 * or in the "license" file accompanying this file. This file is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
```
* Use [`@NonNull`](https://developer.android.com/reference/kotlin/androidx/annotation/NonNull)
  and [`@Nullable`](https://developer.android.com/reference/kotlin/androidx/annotation/Nullable)
  annotations on any/all params, so that
  [Kotlin knows what to do](https://kotlinlang.org/docs/reference/java-interop.html#nullability-annotations),
  when it consumes the library;
* Label Arrange/Act/Assert portions of your unit tests, so others can follow
  their flow;
* Arrange shared dependencies and test objects in an
  [`@Before`](http://junit.sourceforge.net/javadoc/org/junit/Before.html) method;
* Prefer `private` and `final` class members where-ever possible. This limits scope
  and mutability;
* Add documentation to anything that says `public` or `protected`. Documentation on `private` elements is not required, but
  that might be a good idea, too, if you're doing some interesting/non-trivial
  work in those places.

These are just some general guidelines. You should also check any [Android Lint](https://developer.android.com/studio/write/lint#overview) warnings introduced by newly added/modified code.

### Build and Validate Your Work

This will perform a clean build, and run all unit
tests. This must complete successfully before proposing a PR.

```
./gradlew clean build
```

### Run Instrumentation Tests

The instrumentation tests presume the presence of various backend resources.
Currently, there is no mechanism for contributors to easily allocate
these resources. 

AWS maintainers can gain access to `awsconfiguration.json` and
`testconfiguration.json` files in an S3 bucket, to find
configurations suitable for running the integration tests.

The file locations can be found in the `Configure test information` command in the `.circleci/config.yml` file.

To run a __specific__ test:

```bash
test='com.amazonaws.mobileconnectors.cognitoidentityprovider.SignInPersistenceIntegrationTest#testSignIn'
./gradlew cAT -Pandroid.testInstrumentationRunnerArguments.class="$test"
```

To run __all__ tests:

```
./gradlew cAT
```

## Contributing via Pull Requests

Generally, you should follow the same steps as in [GitHub's guide on creating a pull request](link).

First, create a _fork_ of `aws-sdk-android`. Clone it, and make changes to this _fork_.

```
git clone git@github.com:your_username/aws-sdk-android.git 
```

After you have tested your feature/fix, by adding sufficient test coverage, addressing any issues reported [Android Lint](https://developer.android.com/studio/write/lint#overview) and the existing test suites, you're ready to
publish your change.

Start by reviewing [these best practices for Git commit messages](https://chris.beams.io/posts/git-commit/).

The commit message should look like below. It started with a bracketed tag
stating which module has been the focus of the change. After a paragraph
describing what you've done, include links to useful resources. These might
include design documents, StackOverflow implementation notes, GitHub issues,
etc. All links must be publicly accessible. Additionally, SDK commits include a bracketed tag in the commit slug, stating which module has been the focus of a change.

__NOTE__: this is not an actual change that has been implemented. Only an example commit message.

```
[aws-android-sdk-core] Added new pre-defined retry policy

Added a new retry policy to allow retries on select exception types

Resolves: https://github.com/aws-sdk-android/issues/XXXX
```

Now, save your work to a new branch:

```
git checkout -B new_retry_policy
```

To publish it:

```
git push origin new_retry_policy
```

This last step will output an GitHub URL that you can view in your web browser.
Copy-paste this, and complete the workflow in the UI. It will invite you to
"create a PR" from your newly published branch.

Your should add the
**[Amplify-Native](https:~~/~~/github.com/orgs/aws-amplify/teams/amplify-native)**
team as a reviewer of your PR.

Your PR must be reviewed by at least one member of this team, in order to be
considered for inclusion.

your PR must also pass the CircleCI workflow and LGTM validations. CircleCI
will run all build tasks (Lint, unit tests).

Currently, CircleCI **DOES NOT** run instrumentation tests for PRs that come
from user forks. You should run these tests on your laptop before submitting
the PR.

## Troubleshooting

### Environment Debugging

Are you using the right versions of Gradle, Ant, Groovy, Kotlin, Java, Mac OS X?
    
  ```
    ------------------------------------------------------------
    Gradle 4.4
    ------------------------------------------------------------
    
    Build time:   2017-12-06 09:05:06 UTC
    Revision:     cf7821a6f79f8e2a598df21780e3ff7ce8db2b82
    
    Groovy:       2.4.12
    Ant:          Apache Ant(TM) version 1.9.9 compiled on February 2 2017
    JVM:          1.8.0_212-release (JetBrains s.r.o 25.212-b4-5784211)
    OS:           Mac OS X 10.14.6 x86_64
    ```
    
    Do you have the Android SDK setup, and do you have a pointer to the Java environment?
    
    ```
    echo -e $ANDROID_HOME\\n$JAVA_HOME 
    /Users/jhwill/Library/Android/sdk
    /Applications/Android Studio.app/Contents/jre/jdk/Contents/Home
  ```

### Problems with the Build

Take a look at the build instructions in the project's [README.md](https://github.com/aws-amplify/aws-sdk-android#building-the-sdk).

If the build fails, and you can't figure out why from a Google search /
StackOverflow session, try passing options to Gradle:

```
./gradlew --stacktrace
```

The next flag will spit out lots of info. It's only useful if you pipe the
output to a file, and grep through it.

```
./gradlew --debug 2>&1 > debugging-the-build.log
```

### Failing Instrumentation Tests

If a single test is failing, run only that test, to isolate it. You may also
want to see the output on the device that occurs, while the tests are
executing.

```bash
# If you run this same code in a script/block, this will clear the log
# file each time.
rm -f device-logs-during-test.log

# Clear the device's, so you only get recent stuff.
adb logcat -c

# Run a particular test.
test='com.amazonaws.mobileconnectors.cognitoidentityprovider.SignInPersistenceIntegrationTest#testSignIn'
./gradlew cAT -Pandroid.testInstrumentationRunnerArguments.class="$test"

# Dump the device logs to your debugging file.
adb logcat -d > device-logs-during-test.log
```

Now, you can inspect both the test execution results, as well as what was
happening on the device, in `device-logs-during-test.log`.

## Related Repositories
This SDK was originially forked from the [AWS Java SDK](https://github.com/aws/aws-sdk-java) which provides direct access to AWS backend resources. The mobile SDK not only offers this capability, but also provides additional higher level abstractions (mobile connectors) which make mobile development easier.

Other AWS Mobile SDKs include:

1. [AWS SDK for iOS](https://github.com/aws-amplify/aws-sdk-ios)
2. [AWS SDK for JavaScript](https://github.com/aws/aws-sdk-js)

We are building a higher level framework that is built on top of the AWS SDKs to make real use cases easier for mobile developers, make sure you check them out!

1. [AWS Amplify for iOS](https://github.com/aws-amplify/amplify-ios)
2. [AWS Amplify for Android](https://github.com/aws-amplify/amplify-android)
3. [AWS Amplify for JS](https://github.com/aws-amplify/amplify-js)

## Finding contributions to work on
Looking at [the existing issues](https://github.com/aws-amplify/aws-sdk-android/issues) is a
great way to find something to work on.

## Code of Conduct
This project has adopted the [Amazon Open Source Code of Conduct](https://aws.github.io/code-of-conduct).
For more information see the [Code of Conduct FAQ](https://aws.github.io/code-of-conduct-faq) or contact
[opensource-codeofconduct@amazon.com](mailto:opensource-codeofconduct@amazon.com) with any additional questions or comments.

## Security issue notifications
If you discover a potential security issue in this project we ask that you notify AWS/Amazon Security via our
[vulnerability reporting page](http://aws.amazon.com/security/vulnerability-reporting/). Please
do **not** create a public GitHub issue.

## Licensing

See the
[LICENSE](https://github.com/awslabs/aws-sdk-android/blob/master/LICENSE)
for more information. We will ask you to confirm the licensing of your
contribution.

We may ask you to sign a
[Contributor License Agreement (CLA)](http://en.wikipedia.org/wiki/Contributor_License_Agreement) for
larger changes.

