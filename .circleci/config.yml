# Android CircleCI 2.0 configuration file
#
version: 2
jobs:
  build:
    working_directory: ~/code
    docker:
      - image: circleci/android:api-27-alpha
    environment:
      JVM_OPTS: -Xmx3200m
    steps:
      - checkout
      - run:
          name: build the whole project
          command: bash gradlew build -x test

  unittest:
    working_directory: ~/code
    docker:
      - image: circleci/android:api-27-alpha
    environment:
      JVM_OPTS: -Xmx1024m
    steps:
      - checkout

      - run:
          name: test
          command : |
            mkdir -p ~/.gradle && echo "org.gradle.daemon=false" >> ~/.gradle/gradle.properties
      - run:
          name: run unit tests
          command: |
            currentfolder=$(pwd)
            python3 CircleciScripts/run_unittest.py test_results "$currentfolder"
      - run:
          name : check unit test result 
          command : bash CircleciScripts/check_test_result.sh test_results
          
      - store_artifacts:
          path: test_results

  release_tag:
    working_directory: ~/code
    docker:
      - image:  circleci/golang:1.11
    steps:
      - checkout
      - run:
          name: install github-release
          command: go get github.com/aktau/github-release          
      - run:
          name: release the tag
          command: |
            export release_tag=${CIRCLE_TAG}
            export version=$(echo "$release_tag" | sed 's|.*v\([0-9\.]*\).*|\1|')
            export tagdescription=$(sed -n "/## \[Release $version\]/,/## \[Release [0-9]*\.[0-9]*\.[0-9]\]/p"  CHANGELOG.md | sed '1d' | sed '$d')
            echo "$tagdescription" | github-release release  -s ${GH_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME}  -t $release_tag   --name  "$tagname" -d - 

  release_javadoc:
    docker:
      - image: circleci/android:api-27-alpha
    environment:
      JVM_OPTS: -Xmx3200m     
    steps:
      - checkout   
      - run: 
          name: install json parser
          command: |
            sudo apt-get update
            sudo apt-get -y install python3-pip
      - run: 
          name: install json parser
          command: sudo pip3 install demjson
      - run:
          name: install aws cli
          command: |
            sudo pip install awscli

      - run:
          name: download third party libararies 
          command: |
            aws s3 sync  s3://android-circleci-payload/third-party/  ./libs                

      - run:
          name: set version
          command: |
            export release_tag=${CIRCLE_TAG}
            echo "release_tag=$release_tag" >> $BASH_ENV
            export release_version=$(echo "$release_tag" | sed 's|.*v\([0-9\.]*\).*|\1|') 
            echo "release_version=$release_version" >> $BASH_ENV
      - run:
          name: generate documents
          command: |
            currentfolder=$(pwd)
            python3 CircleciScripts/generatejavadoc.py CircleciScripts/ReleaseConfiguration.json "$currentfolder" build/javadoc libs "$release_version"
      

      - run:
          name: check out gh-pages and preserve old document
          command: |
            git config --local user.name "${GITHUB_USER}"
            git checkout  gh-pages
            git checkout master CircleciScripts/preserveolddocument.sh
            set +e
            bash CircleciScripts/preserveolddocument.sh
      - run:
          name: copy new document
          command: |
            cp -R build/javadoc/*   docs/reference/

      - run:
          name: check out gh-pages
          command: |
            cp -R build/javadoc/*   docs/reference/

      - run:
          name: check in documents
          command: |
            git add docs/reference
            git commit -m "AWS SDK for Android $release_version"
            git push -q https://${GITHUB_TOKEN}@github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}.git  
      - save_cache:
          key: API-Reference-{{ .Revision }}
          paths:
            - docs/reference/



  tag_doc:
    docker:
      - image: circleci/android:api-27-alpha
    environment:
      JVM_OPTS: -Xmx3200m     
    steps:
      - checkout   
      - run:
          name: Add documentation tags to gh-pages
          command: |
            git config --local user.name "${GITHUB_USER}"
            git checkout  gh-pages
            git tag -a ${CIRCLE_TAG}_api_docs  -m "Add documentation tags to version ${CIRCLE_TAG}"            
            git push --tags -q https://${GITHUB_TOKEN}@github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}.git     

  release_maven:
    macos: 
      xcode: "10.1.0"

    steps:
      - checkout    
      - run:
          name: install android sdk tools
          command: |
            brew tap caskroom/cask
            brew cask install android-sdk
      - run:
          name: install aws cli
          command: |
            sudo pip install awscli
      - run:
          name: install android build tools
          command: |
            sudo yes | /usr/local/bin/sdkmanager "platforms;android-21" "platforms;android-27" "build-tools;27.0.1"  "extras;google;m2repository" "extras;android;m2repository"          
            /usr/local/bin/sdkmanager --update
      - run:
          name: Set environment
          command: |
            echo ~
            ls /usr/local/share/android-sdk
            ANDROID_HOME="/usr/local/share/android-sdk"
            echo 'export ANDROID_HOME="/usr/local/share/android-sdk"' >> $BASH_ENV
            echo "Home: ${HOME}"
            echo "JAVA_HOME: $JAVA_HOME"
            echo "ANDROID_HOME: $ANDROID_HOME"
            echo "PATH: $PATH"                    
            echo 'export ANDROID_PLATFORM="27"' >> $BASH_ENV
            echo 'export ANDROID_BUILDTOOL_VERSION="27.0.1"' >> $BASH_ENV
      - run:
          name: Instal gpg
          command: |
            brew install gnupg

      - run:
          name: download gpghome
          command: |
            aws s3 cp s3://android-circleci-payload/gpghome/gpghome.zip gpghome.zip
            unzip -a gpghome.zip
            echo "gpghome contents:"
            ls gpghome

      - run:
         name: install maven
         command: |
            brew update 
            brew install maven

      - run:
          name: publish to maven
          command: |
            echo "${HOME}"
            echo "$JAVA_HOME"
            echo "$ANDROID_HOME"
            echo "$M2_HOME"
            bash CircleciScripts/maven-release.sh

  release_s3:
    docker:
      - image: circleci/android:api-27-alpha
    environment:
      JVM_OPTS: -Xmx1024m     
    steps:
      - checkout   
      - run:
          name: download sdk resource
          command: |
            version=2.10.0
            sdkversion="aws-android-sdk-$version"
            echo "sdkversion=$sdkversion" >> $BASH_ENV
            git checkout resource aws-android-sdk
            mv aws-android-sdk "$sdkversion"
      - run:
          name: copy libs
          command:
             bash gradlew build -x test
             rootfolder=$(pwd)
             python3 CircleciScripts/copylibs.py  "$sdkversion/lib"
      - restore_cache:
          key: API-Reference-{{ .Revision }}
      - run:
          name: copy documents
          command: |
            mkdir -p "$sdkversion/documentation/javadoc"
            cp -R docs/reference/*  "$sdkversion/documentation/javadoc"
      - run:
          name: zip sdk folder
            zip -r "$sdkversion.zip" "$sdkversion"
      - run:
          name: install aws cli
          command: |
            sudo pip install awscli

      - run:
          name: upload to s3
          command: |
            aws configure --profile android_stage set region us-east-1
            echo -e "[android_stage]\naws_access_key_id=${AWS_ACCESS_KEY_ID_ANDROID}\naws_secret_access_key=${AWS_SECRET_ACCESS_KEY_ANDROID}\n" >> ~/.aws/credentials
            aws s3 cp "$sdkversion.zip" s3:///mylistname/test  --profile android_stage          
workflows:
  version: 2
  version: 2
  build_test:
    jobs: 
      - build 
      - unittest:
          requires:
            - build         
 
  #   jobs: 
  #     - build:
  #         filters:
  #           branches:
  #             ignore: /.*/            
  #           tags:
  #             only: /^release_v[0-9]+.[0-9]+.[0-9]+$/

  #     - unittest:
  #         requires:
  #           - build         
  #         filters:
  #           branches:
  #             ignore: /.*/            
  #           tags:
  #             only: /^release_v[0-9]+.[0-9]+.[0-9]+$/ 
  release_sdk:
    jobs:
      - release_tag:                    
          filters:
            branches:
              ignore: /.*/            
            tags:
              only: /^release_v[0-9]+.[0-9]+.[0-9]+$/

      - release_maven:    
          requires:
            - release_tag  
          filters:
            branches:
              ignore: /.*/            
            tags:
              only: /^release_v[0-9]+.[0-9]+.[0-9]+$/

      - release_javadoc:    
          requires:
            - release_maven  
          filters:
            branches:
              ignore: /.*/            
            tags:
              only: /^release_v[0-9]+.[0-9]+.[0-9]+$/

      - tag_doc:    
          requires:
            - release_javadoc  
          filters:
            branches:
              ignore: /.*/            
            tags:
              only: /^release_v[0-9]+.[0-9]+.[0-9]+$/

      - release_s3:    
          requires:
            - release_javadoc  
          filters:
            branches:
              ignore: /.*/            
            tags:
              only: /^release_v[0-9]+.[0-9]+.[0-9]+$/

